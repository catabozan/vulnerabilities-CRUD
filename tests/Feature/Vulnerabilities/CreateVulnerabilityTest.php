<?php

use App\Models\User;
use App\Models\Vulnerability;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Validation\ValidationException;
use function Pest\Laravel\actingAs;
use function Pest\Laravel\post;
use function PHPUnit\Framework\assertEquals;
use function PHPUnit\Framework\assertNotEmpty;

it('can create a vulnerability', function () {
    /** @var User */
    $bob = User::factory()->create();
    actingAs($bob);

    $vulnerabilityToCreate = Vulnerability::factory()->make();

    post(route('vulnerability.store'), [
        'title' => $vulnerabilityToCreate->title,
        'description' => $vulnerabilityToCreate->description,
        'threat_level' => $vulnerabilityToCreate->threat_level,
    ]);

    assertNotEmpty($bob->vulnerabilities);
    assertEquals(
        $vulnerabilityToCreate->title,
        $bob->vulnerabilities->first()->title
    );
    assertEquals(
        $vulnerabilityToCreate->description,
        $bob->vulnerabilities->first()->description
    );
    assertEquals(
        $vulnerabilityToCreate->threat_level,
        $bob->vulnerabilities->first()->threat_level
    );
});

it('validates the request', function () {
    /** @var User */
    $bob = User::factory()->create();
    actingAs($bob);

    $vulnerabilityToCreate = Vulnerability::factory()->make();

    post(route('vulnerability.store'), [
        'title' => $vulnerabilityToCreate->title,
        //  'description' => $vulnerabilityToCreate->description,
        'threat_level' => $vulnerabilityToCreate->threat_level,
    ]);
})->expectException(ValidationException::class);

test('you must be authenticated to create a vulnerability', function () {
    $vulnerabilityToCreate = Vulnerability::factory()->make();

    post(route('vulnerability.store'), [
        'title' => $vulnerabilityToCreate->title,
        'description' => $vulnerabilityToCreate->description,
        'threat_level' => $vulnerabilityToCreate->threat_level,
    ]);
})->expectException(AuthenticationException::class);
